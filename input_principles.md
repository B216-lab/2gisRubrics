# ПОДРОБНО: Входные данные и принцип работы

## 📥 Что подаётся на вход

Система принимает **два типа входных данных**:

### 1️⃣ КАТЕГОРИИ (определяешь один раз)

**Что это:** 46 категорий из твоей таблицы (Жильё, Общепит, Спорт и т.д.)

**Форматы подачи:**

#### Вариант A: Прямо в коде (словарь Python)
```python
categories = [
    {'id': 1, 'name': 'Жильё', 'description': 'Жилой комплекс; частные дома'},
    {'id': 2, 'name': 'Супермаркеты, продуктовые рынки', 'description': 'Супермаркет, продуктовый рынок, аптека'},
    # ... остальные 44 категории
]
```

#### Вариант B: CSV файл `categories.csv`
```
№,Тип,Общее описание
1,Жильё,Жилой комплекс; частные дома
2,Супермаркеты продуктовые рынки,Супермаркет продуктовый рынок аптека
3,Торговля (Не пищевая),Вещи быт-техника обувь цветочный магазин
...
```

#### Вариант C: JSON файл `categories.json`
```json
[
  {
    "id": 1,
    "name": "Жильё",
    "description": "Жилой комплекс; частные дома"
  },
  {
    "id": 2,
    "name": "Супермаркеты, продуктовые рынки",
    "description": "Супермаркет, продуктовый рынок, аптека"
  }
]
```

---

### 2️⃣ РУБРИКИ (то, что нужно классифицировать)

**Что это:** Список всех рубрик из 2ГИС (Администрации районов, Бары, Кафе, Больницы и т.д.)

**Форматы подачи:**

#### ✅ Вариант A: TXT файл (одна рубрика в строке)
**Файл `rubrics.txt`:**
```
Администрации районов / округов городской власти
Федеральные службы
Законодательная власть
Аварийные службы
Благоустройство улиц
Техобслуживание теплоэнергосетей
Подъёмные грузовые / пассажирские устройства
Посольства / Консульства
Инспекции
Налоговые инспекции
```

**Как загрузить в программу:**
```python
# Загрузка из TXT файла
with open('rubrics.txt', 'r', encoding='utf-8') as f:
    rubrics = [line.strip() for line in f if line.strip()]

# Теперь rubrics = ['Администрации районов...', 'Федеральные службы', ...]
```

#### ✅ Вариант B: CSV файл
**Файл `rubrics.csv`:**
```
rubric
Администрации районов / округов городской власти
Федеральные службы
Законодательная власть
Аварийные службы
```

**Как загрузить:**
```python
import pandas as pd

df = pd.read_csv('rubrics.csv', encoding='utf-8')
rubrics = df['rubric'].tolist()
```

#### ✅ Вариант C: JSON файл
**Файл `rubrics.json`:**
```json
[
  "Администрации районов / округов городской власти",
  "Федеральные службы",
  "Законодательная власть",
  "Аварийные службы"
]
```

**Как загрузить:**
```python
import json

with open('rubrics.json', 'r', encoding='utf-8') as f:
    rubrics = json.load(f)
```

#### ✅ Вариант D: Прямо в коде
```python
rubrics = [
    'Администрации районов / округов городской власти',
    'Федеральные службы',
    'Законодательная власть',
    'Аварийные службы',
]
```

---

## 🔄 ПРИНЦИП РАБОТЫ (что происходит внутри)

### Шаг за шагом:

```
1. ЗАГРУЗКА КАТЕГОРИЙ
   ┌─────────────────────────────┐
   │ Жильё                       │
   │ Общепит                     │  ← 46 категорий с описаниями
   │ Спорт                       │
   └─────────────────────────────┘
          ↓
2. ПРЕОБРАЗОВАНИЕ В ВЕКТОРЫ
   ┌──────────────────────────────────────────┐
   │ [0.32, -0.15, 0.89, 0.21, ..., -0.45]   │  ← Вектор "Жильё"
   │ [0.12, 0.56, -0.23, 0.88, ..., 0.12]    │  ← Вектор "Общепит"
   │ [0.78, -0.34, 0.12, -0.55, ..., 0.90]   │  ← Вектор "Спорт"
   └──────────────────────────────────────────┘
        ↓
3. ЗАГРУЗКА РУБРИК
   ┌────────────────────────────┐
   │ Администрации районов      │
   │ Бары                       │  ← рубрики из 2ГИС
   │ Кафе                       │
   └────────────────────────────┘
        ↓
4. ПРЕОБРАЗОВАНИЕ РУБРИК В ВЕКТОРЫ
   ┌──────────────────────────────────────────┐
   │ [0.45, -0.22, 0.67, 0.15, ..., -0.30]   │  ← Вектор "Администрации районов"
   │ [0.88, 0.34, -0.12, 0.45, ..., 0.72]    │  ← Вектор "Бары"
   │ [0.91, 0.28, -0.08, 0.52, ..., 0.75]    │  ← Вектор "Кафе"
   └──────────────────────────────────────────┘
        ↓
5. СРАВНЕНИЕ (косинусное сходство)
   
   Для рубрики "Кафе":
   
   Сравнение с "Жильё"       → 0.12 (12% похожесть)
   Сравнение с "Общепит"     → 0.94 (94% похожесть) ⭐ ЛУЧШЕ ВСЕГО
   Сравнение с "Спорт"       → 0.18 (18% похожесть)
        ↓
6. РЕЗУЛЬТАТ (сортировка по убыванию)
   
   Рубрика: "Кафе"
   1. Общепит      → 0.94 (94%)  ✓
   2. Торговля     → 0.31 (31%)
   3. Досуг        → 0.25 (25%)
```

---

## 💻 СПОСОБ ИСПОЛЬЗОВАНИЯ

### Вариант 1: КОМАНДНАЯ СТРОКА (просто + быстро)

**Если у тебя есть файлы готовые:**

**Структура папки:**
```
project/
├── rubrics_classifier.py      ← основной модуль (не трогаем)
├── quick_run.py              ← новый скрипт (ниже)
├── categories.csv            ← твои 46 категорий
└── rubrics.txt               ← рубрики из 2ГИС
```

**Создаёшь файл `quick_run.py`:**
```python
#!/usr/bin/env python3
"""Быстрая классификация через командную строку"""

from rubrics_classifier import RubricsClassifier

# 1. ЗАГРУЖАЕМ КАТЕГОРИИ из CSV
import pandas as pd
categories_df = pd.read_csv('categories.csv', encoding='utf-8')
categories = [
    {
        'id': row['№'],
        'name': row['Тип'],
        'description': row['Общее описание']
    }
    for _, row in categories_df.iterrows()
]

# 2. ЗАГРУЖАЕМ РУБРИКИ из TXT
with open('rubrics.txt', 'r', encoding='utf-8') as f:
    rubrics = [line.strip() for line in f if line.strip()]

print(f"Загружено категорий: {len(categories)}")
print(f"Загружено рубрик: {len(rubrics)}")

# 3. КЛАССИФИЦИРУЕМ
classifier = RubricsClassifier()
classifier.load_categories(categories)

print("\nКлассифицирую...")
results = classifier.classify_batch(rubrics, top_n=3)

# 4. СОХРАНЯЕМ РЕЗУЛЬТАТЫ
classifier.export_results(results, 'results.csv', format='csv')
print("\n✓ Готово! Результаты в results.csv")

# 5. ПОКАЗЫВАЕМ ПЕРВЫЕ 5 РЕЗУЛЬТАТОВ
print("\n" + "="*80)
print("ПРИМЕРЫ РЕЗУЛЬТАТОВ:")
print("="*80)
for result in results[:5]:
    print(f"\n{result['rubric']}")
    for clf in result['classifications']:
        bar = '█' * int(clf['confidence'] * 20)
        print(f"  [{bar:<20}] {clf['category_name']:40} {clf['confidence']:.1%}")
```

**Запуск из командной строки:**
```bash
python quick_run.py
```

**Результат:**
```
Загружено категорий: 46
Загружено рубрик: 100

Классифицирую...
Progress: 100%|██████████████████| 100/100

✓ Готово! Результаты в results.csv

================================================================================
ПРИМЕРЫ РЕЗУЛЬТАТОВ:
================================================================================

Администрации районов / округов городской власти
  [████████████████████] Административное здание      95.2%
  [██░░░░░░░░░░░░░░░░░] Юридические и банковские у  22.3%
  [█░░░░░░░░░░░░░░░░░░] Медицина                     14.5%

Бары
  [███████████████████░] Общепит                      94.3%
  [███░░░░░░░░░░░░░░░░] Досуг                        28.1%
  [██░░░░░░░░░░░░░░░░░] Торговля (Не пищевая)       19.2%

Кафе
  [████████████████████] Общепит                      98.2%
  [████░░░░░░░░░░░░░░░░] Досуг                        34.5%
  [██░░░░░░░░░░░░░░░░░░] Торговля (Не пищевая)      18.7%
```

---

### Вариант 2: ИНТЕРАКТИВНАЯ ПРОГРАММА (с меню)

**Файл `interactive_app.py`:**
```python
#!/usr/bin/env python3
"""Интерактивное меню для классификации"""

from rubrics_classifier import RubricsClassifier
import pandas as pd
import json

def main():
    print("="*80)
    print("СИСТЕМА КЛАССИФИКАЦИИ РУБРИК 2ГИС")
    print("="*80)
    
    # ЗАГРУЗКА КАТЕГОРИЙ
    print("\n1️⃣ Загружаю категории...")
    categories_df = pd.read_csv('categories.csv', encoding='utf-8')
    categories = [
        {
            'id': row['№'],
            'name': row['Тип'],
            'description': row['Общее описание']
        }
        for _, row in categories_df.iterrows()
    ]
    print(f"   ✓ Загружено {len(categories)} категорий")
    
    # ИНИЦИАЛИЗАЦИЯ КЛАССИФИКАТОРА
    print("\n2️⃣ Инициализирую классификатор...")
    classifier = RubricsClassifier()
    classifier.load_categories(categories)
    print("   ✓ Готово")
    
    # МЕНЮ
    while True:
        print("\n" + "="*80)
        print("ВЫБЕРИ ДЕЙСТВИЕ:")
        print("="*80)
        print("1. Классифицировать рубрики из файла")
        print("2. Классифицировать одну рубрику вручную")
        print("3. Выход")
        
        choice = input("\nВвели номер (1-3): ").strip()
        
        if choice == '1':
            # Загрузка из файла
            file_path = input("Путь к файлу (TXT/CSV/JSON): ").strip()
            
            try:
                if file_path.endswith('.txt'):
                    with open(file_path, 'r', encoding='utf-8') as f:
                        rubrics = [line.strip() for line in f if line.strip()]
                elif file_path.endswith('.csv'):
                    df = pd.read_csv(file_path, encoding='utf-8')
                    rubrics = df.iloc[:, 0].tolist()
                elif file_path.endswith('.json'):
                    with open(file_path, 'r', encoding='utf-8') as f:
                        rubrics = json.load(f)
                else:
                    print("❌ Поддерживаются только TXT, CSV, JSON")
                    continue
                
                print(f"\n✓ Загружено {len(rubrics)} рубрик")
                
                top_n = int(input("Сколько топ-категорий вывести? (1-5, по умолчанию 3): ") or 3)
                
                print(f"\nКлассифицирую {len(rubrics)} рубрик...")
                results = classifier.classify_batch(rubrics, top_n=top_n)
                
                output_file = input("Сохранить результаты в файл? (путь или Enter для пропуска): ").strip()
                if output_file:
                    classifier.export_results(results, output_file, format='csv')
                    print(f"✓ Сохранено в {output_file}")
                
                # Показываем первые несколько
                print("\nПервые 5 результатов:")
                for result in results[:5]:
                    print(f"\n{result['rubric']}")
                    for clf in result['classifications']:
                        print(f"  → {clf['category_name']:40} {clf['confidence']:.1%}")
                
            except FileNotFoundError:
                print(f"❌ Файл {file_path} не найден")
        
        elif choice == '2':
            # Одна рубрика вручную
            rubric = input("\nВведи название рубрики: ").strip()
            if rubric:
                results = classifier.classify_rubric(rubric, top_n=5)
                print(f"\n{rubric}:")
                for cat_id, cat_name, confidence in results:
                    bar = '█' * int(confidence * 20)
                    print(f"  [{bar:<20}] {cat_name:40} {confidence:.1%}")
        
        elif choice == '3':
            print("\nДо свидания! 👋")
            break
        
        else:
            print("❌ Неверный выбор")

if __name__ == "__main__":
    main()
```

**Запуск:**
```bash
python interactive_app.py
```

**Пример работы:**
```
================================================================================
СИСТЕМА КЛАССИФИКАЦИИ РУБРИК 2ГИС
================================================================================

1️⃣ Загружаю категории...
   ✓ Загружено 46 категорий

2️⃣ Инициализирую классификатор...
   ✓ Готово

================================================================================
ВЫБЕРИ ДЕЙСТВИЕ:
================================================================================
1. Классифицировать рубрики из файла
2. Классифицировать одну рубрику вручную
3. Выход

Введи номер (1-3): 2

Введи название рубрики: Рестораны

Рестораны:
  [████████████████████] Общепит                      98.4%
  [████░░░░░░░░░░░░░░░░] Досуг                        32.5%
  [██░░░░░░░░░░░░░░░░░░] Торговля (Не пищевая)      18.9%
  [██░░░░░░░░░░░░░░░░░░] Крупный торговый центр     15.3%
  [█░░░░░░░░░░░░░░░░░░░] Медицина                     8.2%
```

---

## 🎯 СРАВНЕНИЕ: Командная строка vs Программа

| Параметр | Командная строка | Интерактивная программа |
|----------|------------------|------------------------|
| **Скорость начала** | ⚡ Мгновенно | 2 секунды загрузки |
| **Много файлов** | ✅ Идеально | ✅ Удобно в цикле |
| **Ручная проверка** | ❌ Нужен доп. скрипт | ✅ Встроено |
| **Сложность** | ✅ Просто | Чуть сложнее |
| **Для батча** | ✅✅✅ Лучше | ✅✅ Хорошо |

---

## 📋 РЕКОМЕНДУЕМЫЙ СПОСОБ ДЛЯ ТЕБЯ

**Я рекомендую:**

1. **Если нужно классифицировать один большой файл:**
   ```bash
   # Просто запускаешь в одну команду
   python quick_run.py
   ```

2. **Если нужно проверять результаты + загружать разные файлы:**
   ```bash
   # Используешь интерактивное меню
   python interactive_app.py
   ```

3. **Если нужно интегрировать в другой скрипт:**
   ```python
   from rubrics_classifier import RubricsClassifier
   
   # Используешь как библиотеку
   classifier = RubricsClassifier()
   # ...
   ```

---

## 🚀 ШАГ ЗА ШАГОМ: С НУЛЯ

**Что делаешь:**

1. **Создаёшь папку проекта:**
   ```bash
   mkdir rubrics_classifier_project
   cd rubrics_classifier_project
   ```

2. **Копируешь файлы:**
   - `rubrics_classifier.py` (основной модуль)
   - `quick_run.py` или `interactive_app.py` (выбираешь один)

3. **Подготавливаешь данные:**
   - `categories.csv` — твои 46 категорий
   - `rubrics.txt` — рубрики из 2ГИС (одна в строке)

4. **Устанавливаешь зависимости:**
   ```bash
   pip install sentence-transformers scikit-learn pandas numpy
   ```

5. **Запускаешь:**
   ```bash
   python quick_run.py
   ```

6. **Получаешь `results.csv`** с классификацией ✅

---

## 📂 СТРУКТУРА ФАЙЛОВ

```
project/
│
├── rubrics_classifier.py       ← Основной модуль (не меняем)
├── quick_run.py               ← Быстрый запуск (копируешь из примера выше)
├── interactive_app.py          ← Интерактивное меню (копируешь)
│
├── categories.csv             ← ТВОИ ДАННЫЕ (заполняешь)
│   (пример выше)
│
├── rubrics.txt                ← ТВОИ ДАННЫЕ (заполняешь)
│   (пример выше)
│
└── results.csv                ← РЕЗУЛЬТАТ (генерируется автоматически)
```

---

## ✅ ПРОВЕРКА

Все ли понятно?

- ✅ **Входные данные** — категории (1 раз) + рубрики (каждый раз)
- ✅ **Форматы** — TXT, CSV, JSON
- ✅ **Принцип** — преобразование в векторы + сравнение по сходству
- ✅ **Способ использования** — командная строка (quick_run.py) или интерактивное меню (interactive_app.py)
